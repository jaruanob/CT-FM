CONSTANTS:
  HIGH_RES_SIZE: [64, 352, 352]
  LOW_RES_SIZE: [32, 128, 128]

project: /home/ibro/Projects/lighter/projects/ssl

trainer:
  _target_: pytorch_lightning.Trainer
  benchmark: True
  max_epochs: 100
  check_val_every_n_epoch: 5
  accelerator: gpu
  devices: 4
  strategy: ddp
  sync_batchnorm: True
  precision: 16
  log_every_n_steps: 1
  logger:
    _target_: lighter.logger.LighterLogger
    save_dir: ${project}/logs/${now:}
    tensorboard: False
    wandb: True
    wandb_project: NLST_swav
  callbacks:
    - _target_: pytorch_lightning.callbacks.ModelCheckpoint
      dirpath: ${trainer.logger.save_dir}/checkpoints
      verbose: True
      save_last: True
      every_n_epochs: 1

system:
  _target_: lighter.LighterSystem
  batch_size: 2
  pin_memory: True
  drop_last_batch: True # Used in SSL cases because of negatives
  num_workers: 3
  # log_input_as: "image_single"

  model:
    _target_: project.models.swav.SwaV
    num_ftrs: 2048
    out_dim: 128
    n_prototypes: 512
    backbone:
      _target_: lighter.utils.replace_layer_with_identity
      layer_name: fc
      model:
        _target_: monai.networks.nets.resnet.resnet50
        pretrained: False
        n_input_channels: 1
        # widen_factor: 2
  
  criterion:
    _target_: lightly.loss.swav_loss.SwaVLoss
    temperature: 0.1
    sinkhorn_iterations: 3
    sinkhorn_epsilon: 0.05
    sinkhorn_gather_distributed: True

  optimizers:
    _target_: torch.optim.Adam
    lr: 5e-5 # 5e-4
    weight_decay: 1e-4
  
#   schedulers:
#     _target_: torch.optim.lr_scheduler.CosineAnnealingLR
#     T_max: ${trainer.max_epochs}
#     eta_min: "${eval: ${system.optimizers.lr} // 50}"

  train_metrics: null
  val_metrics: "${system.train_metrics}"
  test_metrics: "${system.train_metrics}"
  
  train_dataset:
    _target_: project.datasets.nlst_ssl.NLSTDataset
    mode: train
    root_dir: /mnt/data1/NLST/
    transform:
      _target_: torchvision.transforms.Compose
      transforms:
        # - _target_: lighter.transforms.SitkRandomSpacing
        #   prob: 0.25
        #   min_spacing: [0.4, 0.4, 2]
        #   max_spacing: [1, 1, 3]
        #   tolerance: null
        #   default_value: -1024
        #   interpolator: "linear"
        - _target_: lighter.transforms.SitkToTensor
          add_channel_dim: True
        - # Scale from -1024 to 3072 to 0-1 and clip outside values
          _target_: monai.transforms.ScaleIntensityRange
          a_min: -1024
          a_max: 3072
          b_min: 0
          b_max: 1
          clip: True
        - _target_: lighter.transforms.MultiCrop
          high_resolution_transforms:
            - _target_: torchvision.transforms.Compose
              transforms:
                - _target_: monai.transforms.RandSpatialCrop
                  roi_size: ${CONSTANTS.HIGH_RES_SIZE}
                  random_size: False
                - _target_: monai.transforms.RandFlip
                  prob: 0.25
                  spatial_axis: 2
                - # RandHistogramShift serves purpose similar to color jitter
                  # by modifying the intensity histogram
                  _target_: monai.transforms.RandHistogramShift
                  prob: 0.5
                - # RandGaussianSmooth is similar to SimCLR GaussianBlur
                  _target_: monai.transforms.RandGaussianSmooth
                  prob: 0.5
                - _target_: monai.transforms.SpatialPad
                  spatial_size: ${CONSTANTS.HIGH_RES_SIZE}
            - ${.[0]}
          low_resolution_transforms:
            - _target_: torchvision.transforms.Compose
              transforms:
                - _target_: monai.transforms.RandSpatialCrop
                  roi_size: [8, 64, 64]
                  max_roi_size: ${CONSTANTS.LOW_RES_SIZE}
                  random_size: True
                - _target_: monai.transforms.RandFlip
                  prob: 0.25
                  spatial_axis: 2
                - # RandHistogramShift serves purpose similar to color jitter
                  # by modifying the intensity histogram
                  _target_: monai.transforms.RandHistogramShift
                  prob: 0.5
                - # RandGaussianSmooth is similar to SimCLR GaussianBlur
                  _target_: monai.transforms.RandGaussianSmooth
                  prob: 0.5
                - _target_: monai.transforms.SpatialPad
                  spatial_size: ${CONSTANTS.LOW_RES_SIZE}
            - ${.[0]}
            - ${.[0]}
            - ${.[0]}
  val_dataset: null
  test_dataset: null
